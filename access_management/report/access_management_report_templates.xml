<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Summary Report Template -->
    <template id="report_access_management_summary">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <h2>Access Management Summary Report</h2>
                    
                    <div class="row mt-4">
                        <div class="col-xs-6">
                            <strong>Report Date:</strong> <span t-esc="datetime.datetime.now().strftime('%Y-%m-%d')"/>
                        </div>
                        <div class="col-xs-6">
                            <strong>Generated By:</strong> <span t-esc="user.name"/>
                        </div>
                    </div>
                    
                    <t t-if="data.get('date_from') or data.get('date_to')">
                        <div class="row mt-2">
                            <div class="col-xs-12">
                                <strong>Period:</strong>
                                <span t-if="data.get('date_from')" t-esc="data['date_from']"/>
                                <span t-if="data.get('date_from') and data.get('date_to')"> to </span>
                                <span t-if="data.get('date_to')" t-esc="data['date_to']"/>
                            </div>
                        </div>
                    </t>
                    
                    <h3 class="mt-4">Statistics</h3>
                    <table class="table table-condensed">
                        <tbody>
                            <tr>
                                <td><strong>Total Access Rules:</strong></td>
                                <td><span t-esc="total_rules"/></td>
                            </tr>
                            <tr>
                                <td><strong>Active Rules:</strong></td>
                                <td><span t-esc="active_rules"/></td>
                            </tr>
                            <tr>
                                <td><strong>Inactive Rules:</strong></td>
                                <td><span t-esc="inactive_rules"/></td>
                            </tr>
                            <tr>
                                <td><strong>Total Users Affected:</strong></td>
                                <td><span t-esc="total_users"/></td>
                            </tr>
                            <tr>
                                <td><strong>Total Groups Affected:</strong></td>
                                <td><span t-esc="total_groups"/></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3 class="mt-4">Access Rules List</h3>
                    <table class="table table-condensed table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Users</th>
                                <th>Groups</th>
                                <th>Restrictions</th>
                                <th>Created By</th>
                                <th>Created On</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="rules" t-as="rule">
                                <tr>
                                    <td><span t-field="rule.name"/></td>
                                    <td>
                                        <span t-if="rule.active" class="text-success">Active</span>
                                        <span t-else="" class="text-danger">Inactive</span>
                                    </td>
                                    <td><span t-esc="len(rule.user_ids)"/></td>
                                    <td><span t-esc="len(rule.group_ids)"/></td>
                                    <td><span t-field="rule.access_rules_count"/></td>
                                    <td><span t-field="rule.create_uid.name"/></td>
                                    <td><span t-field="rule.create_date" t-options='{"format": "yyyy-MM-dd"}'/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                    
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>
    
    <!-- Detailed Report Template -->
    <template id="report_access_management_detailed">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <h2>Access Management Detailed Report</h2>
                    
                    <div class="row mt-4">
                        <div class="col-xs-6">
                            <strong>Report Date:</strong> <span t-esc="datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')"/>
                        </div>
                        <div class="col-xs-6">
                            <strong>Generated By:</strong> <span t-esc="user.name"/>
                        </div>
                    </div>
                    
                    <t t-foreach="data.get('report_data', [])" t-as="rule_data">
                        <div class="page-break-before">
                            <h3 class="mt-4"><span t-esc="rule_data['rule'].name"/></h3>
                            
                            <div class="row">
                                <div class="col-xs-6">
                                    <table class="table table-condensed">
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                <span t-if="rule_data['rule'].active" class="text-success">Active</span>
                                                <span t-else="" class="text-danger">Inactive</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Apply by Group:</strong></td>
                                            <td><span t-field="rule_data['rule'].apply_by_group"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Read Only:</strong></td>
                                            <td><span t-field="rule_data['rule'].read_only"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Company:</strong></td>
                                            <td><span t-field="rule_data['rule'].company_id"/></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-xs-6">
                                    <table class="table table-condensed">
                                        <tr>
                                            <td><strong>Created By:</strong></td>
                                            <td><span t-field="rule_data['rule'].create_uid.name"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Created On:</strong></td>
                                            <td><span t-field="rule_data['rule'].create_date"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Updated:</strong></td>
                                            <td><span t-field="rule_data['rule'].write_date"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Restrictions:</strong></td>
                                            <td><span t-field="rule_data['rule'].access_rules_count"/></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div t-if="rule_data['users']">
                                <h4>Users</h4>
                                <ul>
                                    <li t-foreach="rule_data['users']" t-as="user">
                                        <span t-field="user.name"/> (<span t-field="user.login"/>)
                                    </li>
                                </ul>
                            </div>
                            
                            <div t-if="rule_data['groups']">
                                <h4>Groups</h4>
                                <ul>
                                    <li t-foreach="rule_data['groups']" t-as="group">
                                        <span t-field="group.name"/>
                                    </li>
                                </ul>
                            </div>
                            
                            <div t-if="rule_data['menu_access']">
                                <h4>Hidden Menus</h4>
                                <table class="table table-condensed table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Menu</th>
                                            <th>Hidden</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="rule_data['menu_access']" t-as="menu">
                                            <td><span t-field="menu.menu_id.complete_name"/></td>
                                            <td><span t-field="menu.hidden"/></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div t-if="rule_data['model_access']">
                                <h4>Model Access</h4>
                                <table class="table table-condensed table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Model</th>
                                            <th>Read</th>
                                            <th>Write</th>
                                            <th>Create</th>
                                            <th>Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="rule_data['model_access']" t-as="model">
                                            <td><span t-field="model.model_id.name"/></td>
                                            <td class="text-center">
                                                <i t-if="model.perm_read" class="fa fa-check text-success"/>
                                                <i t-else="" class="fa fa-times text-danger"/>
                                            </td>
                                            <td class="text-center">
                                                <i t-if="model.perm_write" class="fa fa-check text-success"/>
                                                <i t-else="" class="fa fa-times text-danger"/>
                                            </td>
                                            <td class="text-center">
                                                <i t-if="model.perm_create" class="fa fa-check text-success"/>
                                                <i t-else="" class="fa fa-times text-danger"/>
                                            </td>
                                            <td class="text-center">
                                                <i t-if="model.perm_unlink" class="fa fa-check text-success"/>
                                                <i t-else="" class="fa fa-times text-danger"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div t-if="rule_data['field_access']">
                                <h4>Field Access</h4>
                                <table class="table table-condensed table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Model</th>
                                            <th>Field</th>
                                            <th>Read Only</th>
                                            <th>Invisible</th>
                                            <th>Required</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="rule_data['field_access']" t-as="field">
                                            <td><span t-field="field.model_id.name"/></td>
                                            <td><span t-field="field.field_id.field_description"/></td>
                                            <td class="text-center">
                                                <i t-if="field.readonly" class="fa fa-check text-warning"/>
                                            </td>
                                            <td class="text-center">
                                                <i t-if="field.invisible" class="fa fa-check text-info"/>
                                            </td>
                                            <td class="text-center">
                                                <i t-if="field.required" class="fa fa-check text-danger"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div t-if="rule_data['domain_access']">
                                <h4>Domain Access</h4>
                                <table class="table table-condensed table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Model</th>
                                            <th>Description</th>
                                            <th>Domain</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="rule_data['domain_access']" t-as="domain">
                                            <td><span t-field="domain.model_id.name"/></td>
                                            <td><span t-field="domain.name"/></td>
                                            <td><code><span t-field="domain.domain"/></code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </t>
                    
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>
    
    <!-- User Access Report Template -->
    <template id="report_access_management_user_access">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <h2>User Access Report</h2>
                    
                    <div class="row mt-4">
                        <div class="col-xs-6">
                            <strong>Report Date:</strong> <span t-esc="data.get('date', '')"/>
                        </div>
                        <div class="col-xs-6">
                            <strong>Generated By:</strong> <span t-esc="user.name"/>
                        </div>
                    </div>
                    
                    <t t-foreach="data.get('user_access_data', [])" t-as="user_data">
                        <div class="page-break-inside">
                            <h3 class="mt-4">
                                <i class="fa fa-user"/> <span t-esc="user_data['user'].name"/>
                            </h3>
                            
                            <table class="table table-condensed">
                                <tr>
                                    <td><strong>Login:</strong></td>
                                    <td><span t-field="user_data['user'].login"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td><span t-field="user_data['user'].email"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Active Rules:</strong></td>
                                    <td><span t-esc="user_data['total_rules']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Menu Restrictions:</strong></td>
                                    <td><span t-esc="user_data['menu_restrictions']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Model Restrictions:</strong></td>
                                    <td><span t-esc="user_data['model_restrictions']"/></td>
                                </tr>
                                <tr>
                                    <td><strong>Field Restrictions:</strong></td>
                                    <td><span t-esc="user_data['field_restrictions']"/></td>
                                </tr>
                            </table>
                            
                            <h4>Applied Access Rules</h4>
                            <table class="table table-condensed table-bordered">
                                <thead>
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Type</th>
                                        <th>Read Only</th>
                                        <th>Company</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="user_data['rules']" t-as="rule">
                                        <td><span t-field="rule.name"/></td>
                                        <td>
                                            <span t-if="rule.apply_by_group">Group-based</span>
                                            <span t-else="">User-based</span>
                                        </td>
                                        <td>
                                            <span t-if="rule.read_only">Yes</span>
                                            <span t-else="">No</span>
                                        </td>
                                        <td><span t-field="rule.company_id.name"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </t>
                    
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>
    
    <!-- Audit Report Template -->
    <template id="report_access_management_audit">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <h2>Access Management Audit Report</h2>
                    
                    <div class="row mt-4">
                        <div class="col-xs-6">
                            <strong>Audit Period:</strong>
                            <span t-esc="data.get('date_from', '')"/> to 
                            <span t-esc="data.get('date_to', '')"/>
                        </div>
                        <div class="col-xs-6">
                            <strong>Generated By:</strong> <span t-esc="user.name"/>
                        </div>
                    </div>
                    
                    <h3 class="mt-4">Rule Creation Activity</h3>
                    <table class="table table-condensed table-bordered">
                        <thead>
                            <tr>
                                <th>Rule Name</th>
                                <th>Created By</th>
                                <th>Created On</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="created_rules" t-as="rule">
                                <tr>
                                    <td><span t-field="rule.name"/></td>
                                    <td><span t-field="rule.create_uid.name"/></td>
                                    <td><span t-field="rule.create_date"/></td>
                                    <td>
                                        <span t-if="rule.active" class="text-success">Active</span>
                                        <span t-else="" class="text-danger">Inactive</span>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                    
                    <h3 class="mt-4">Rule Modification Activity</h3>
                    <table class="table table-condensed table-bordered">
                        <thead>
                            <tr>
                                <th>Rule Name</th>
                                <th>Modified By</th>
                                <th>Modified On</th>
                                <th>Changes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="modified_rules" t-as="rule">
                                <tr>
                                    <td><span t-field="rule.name"/></td>
                                    <td><span t-field="rule.write_uid.name"/></td>
                                    <td><span t-field="rule.write_date"/></td>
                                    <td>
                                        <span t-esc="get_rule_changes(rule)"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                    
                    <h3 class="mt-4">Access Violations</h3>
                    <t t-if="access_violations">
                        <table class="table table-condensed table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Model</th>
                                    <th>Operation</th>
                                    <th>Rule</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="access_violations" t-as="violation">
                                    <tr>
                                        <td><span t-esc="violation['date']"/></td>
                                        <td><span t-esc="violation['user']"/></td>
                                        <td><span t-esc="violation['model']"/></td>
                                        <td><span t-esc="violation['operation']"/></td>
                                        <td><span t-esc="violation['rule']"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                    <t t-else="">
                        <p>No access violations detected during the audit period.</p>
                    </t>
                    
                    <h3 class="mt-4">Summary Statistics</h3>
                    <table class="table table-condensed">
                        <tr>
                            <td><strong>Total Rules Created:</strong></td>
                            <td><span t-esc="total_created"/></td>
                        </tr>
                        <tr>
                            <td><strong>Total Rules Modified:</strong></td>
                            <td><span t-esc="total_modified"/></td>
                        </tr>
                        <tr>
                            <td><strong>Total Rules Deleted:</strong></td>
                            <td><span t-esc="total_deleted"/></td>
                        </tr>
                        <tr>
                            <td><strong>Total Access Violations:</strong></td>
                            <td><span t-esc="total_violations"/></td>
                        </tr>
                        <tr>
                            <td><strong>Most Active User:</strong></td>
                            <td><span t-esc="most_active_user"/></td>
                        </tr>
                    </table>
                    
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>
    
    <!-- Register Report Actions -->
    <record id="action_report_access_management_summary" model="ir.actions.report">
        <field name="name">Access Management Summary</field>
        <field name="model">access.management</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">access_management.report_access_management_summary</field>
        <field name="report_file">access_management.report_access_management_summary</field>
        <field name="print_report_name">'Access Management Summary - %s' % (object.name)</field>
        <field name="binding_model_id" ref="model_access_management"/>
        <field name="binding_type">report</field>
    </record>
    
    <record id="action_report_access_management_detailed" model="ir.actions.report">
        <field name="name">Access Management Detailed</field>
        <field name="model">access.management</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">access_management.report_access_management_detailed</field>
        <field name="report_file">access_management.report_access_management_detailed</field>
        <field name="print_report_name">'Access Management Detailed - %s' % (object.name)</field>
        <field name="binding_model_id" ref="model_access_management"/>
        <field name="binding_type">report</field>
    </record>
    
    <record id="action_report_access_management_user_access" model="ir.actions.report">
        <field name="name">User Access Report</field>
        <field name="model">access.management.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">access_management.report_access_management_user_access</field>
        <field name="report_file">access_management.report_access_management_user_access</field>
        <field name="print_report_name">'User Access Report - %s' % (time.strftime('%Y-%m-%d'))</field>
    </record>
    
    <record id="action_report_access_management_audit" model="ir.actions.report">
        <field name="name">Access Management Audit</field>
        <field name="model">access.management.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">access_management.report_access_management_audit</field>
        <field name="report_file">access_management.report_access_management_audit</field>
        <field name="print_report_name">'Access Audit Report - %s' % (time.strftime('%Y-%m-%d'))</field>
    </record>
</odoo>
